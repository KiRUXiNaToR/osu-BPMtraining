<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osu! BPM Мастер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f1525 0%, #1a1f35 100%);
            color: #f0f0f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Основной контейнер */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Заголовок */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff66b2, #66ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        /* Главная сетка */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
            min-height: 700px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Панель управления */
        .control-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
        }

        .section-title {
            color: #66ccff;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 204, 255, 0.3);
            font-size: 1.3rem;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Группы ввода */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #aaa;
            font-size: 1rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ff66b2;
            box-shadow: 0 0 0 3px rgba(255, 102, 178, 0.2);
        }

        /* Слайдер */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .slider-value {
            min-width: 70px;
            background: rgba(255, 102, 178, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Кнопки пресетов */
        .presets-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .preset-btn, .time-btn {
            background: rgba(102, 204, 255, 0.1);
            border: 2px solid rgba(102, 204, 255, 0.3);
            color: #66ccff;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .preset-btn:hover, .time-btn:hover {
            background: rgba(102, 204, 255, 0.2);
            transform: translateY(-2px);
        }

        .preset-btn.active, .time-btn.active {
            background: rgba(102, 204, 255, 0.3);
            border-color: #ff66b2;
            color: #fff;
        }

        /* Настройка клавиш */
        .keys-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .key-input {
            text-align: center;
        }

        .key-input label {
            margin-bottom: 5px;
        }

        .key-preview {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
            transition: all 0.2s;
        }

        .key-preview.active {
            background: rgba(255, 102, 178, 0.3);
            border-color: #ff66b2;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 102, 178, 0.5);
        }

        /* Переключатель */
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: #4ade80;
        }

        input:checked + .switch-slider:before {
            transform: translateX(24px);
        }

        /* Основные кнопки */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        button {
            padding: 14px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .primary-btn {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .danger-btn {
            background: linear-gradient(90deg, #f87171, #dc2626);
            color: white;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Область тренировки */
        .training-area {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Фуллскрин режим тренировки */
        .training-area.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            z-index: 1000;
            padding: 20px;
            background: rgba(10, 15, 30, 0.95);
        }

        .fullscreen-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }

        .fullscreen-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Дисплей BPM */
        .bpm-main-display {
            font-size: 8rem;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
            transition: all 0.2s ease;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
            color: #66ccff;
        }

        .training-area.fullscreen .bpm-main-display {
            font-size: 12rem;
            margin: 40px 0;
        }

        .bpm-main-display.perfect {
            color: #4ade80;
            text-shadow: 0 0 40px rgba(74, 222, 128, 0.7);
        }

        .bpm-main-display.late {
            color: #f87171;
            text-shadow: 0 0 40px rgba(248, 113, 113, 0.7);
        }

        .bpm-main-display.early {
            color: #fbbf24;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.7);
        }

        /* Индикатор точности */
        .accuracy-indicator {
            font-size: 1.8rem;
            margin: 15px 0;
            height: 40px;
            text-align: center;
        }

        .training-area.fullscreen .accuracy-indicator {
            font-size: 2.2rem;
            margin: 25px 0;
        }

        .hit-perfect {
            color: #4ade80;
        }

        .hit-late {
            color: #f87171;
        }

        .hit-early {
            color: #fbbf24;
        }

        /* Статус тренировки */
        .training-status {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .training-timer {
            font-size: 3rem;
            font-weight: bold;
            color: #ff66b2;
            margin-bottom: 10px;
        }

        .training-area.fullscreen .training-timer {
            font-size: 4rem;
        }

        .hits-counter {
            font-size: 1.8rem;
            color: #66ccff;
        }

        .training-area.fullscreen .hits-counter {
            font-size: 2.2rem;
        }

        /* Подсказка клавиш */
        .keys-hint {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 40px;
        }

        .training-area.fullscreen .keys-hint {
            gap: 80px;
            margin-top: 60px;
        }

        .key-hint-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .key-hint-box {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            transition: all 0.1s;
        }

        .training-area.fullscreen .key-hint-box {
            width: 140px;
            height: 140px;
            font-size: 3.5rem;
        }

        .key-hint-box.active {
            background: rgba(255, 102, 178, 0.3);
            border-color: #ff66b2;
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 102, 178, 0.5);
        }

        .key-hint-label {
            font-size: 1.1rem;
            color: #aaa;
            text-align: center;
        }

        .training-area.fullscreen .key-hint-label {
            font-size: 1.4rem;
        }

        /* Панель результатов */
        .results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 15, 30, 0.98);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 30px;
            overflow-y: auto;
        }

        .results-overlay.active {
            display: flex;
        }

        .results-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .results-header h2 {
            font-size: 2.8rem;
            color: #66ccff;
            margin-bottom: 15px;
        }

        .results-header p {
            font-size: 1.3rem;
            color: #aaa;
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-top: 4px solid #ff66b2;
        }

        .stat-value {
            font-size: 3.5rem;
            font-weight: bold;
            color: #fff;
            line-height: 1;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #66ccff;
            margin-top: 10px;
        }

        /* График */
        .chart-section {
            margin-bottom: 40px;
        }

        .chart-section h3 {
            font-size: 1.8rem;
            color: #66ccff;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
        }

        /* Кнопки результатов */
        .results-buttons {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
        }

        .results-buttons button {
            min-width: 200px;
        }

        /* Подвал */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            opacity: 0.7;
            font-size: 0.95rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Инструкция */
        .instructions {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .instructions h3 {
            color: #66ccff;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .instructions ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions .hotkey {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 3px;
        }

        /* Счётчик BPM */
        .bpm-counter-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .counter-display {
            font-size: 5rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #ff66b2;
            text-shadow: 0 0 30px rgba(255, 102, 178, 0.5);
        }

        .counter-timer {
            font-size: 2rem;
            text-align: center;
            margin: 15px 0;
            color: #66ccff;
        }

        .counter-progress {
            height: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .counter-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #66ccff, #ff66b2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .counter-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-drum"></i> osu! BPM Мастер</h1>
            <p class="subtitle">Тренажёр точности нажатий для стримов</p>
        </header>
        
        <div class="main-grid">
            <!-- ЛЕВАЯ ПАНЕЛЬ: НАСТРОЙКИ -->
            <div class="control-panel">
                <h3 class="section-title"><i class="fas fa-cog"></i> Настройки тренажёра</h3>
                
                <div class="input-group">
                    <label for="targetBPM"><i class="fas fa-bullseye"></i> Целевой BPM</label>
                    <input type="number" id="targetBPM" min="60" max="400" value="180" step="1">
                    
                    <div class="presets-grid">
                        <div class="preset-btn" data-bpm="120">120 BPM</div>
                        <div class="preset-btn" data-bpm="160">160 BPM</div>
                        <div class="preset-btn" data-bpm="180">180 BPM</div>
                        <div class="preset-btn" data-bpm="200">200 BPM</div>
                        <div class="preset-btn" data-bpm="220">220 BPM</div>
                        <div class="preset-btn" data-bpm="240">240 BPM</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="toleranceSlider"><i class="fas fa-bullseye"></i> Допуск (± BPM)</label>
                    <div class="slider-container">
                        <input type="range" id="toleranceSlider" min="1" max="20" step="1" value="5">
                        <span class="slider-value" id="toleranceValue">±5 BPM</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label><i class="fas fa-clock"></i> Время тренировки</label>
                    <div class="presets-grid">
                        <div class="time-btn" data-time="10">10 сек</div>
                        <div class="time-btn active" data-time="30">30 сек</div>
                        <div class="time-btn" data-time="60">60 сек</div>
                        <div class="time-btn" data-time="120">120 сек</div>
                    </div>
                </div>
                
                <h3 class="section-title"><i class="fas fa-keyboard"></i> Настройка клавиш</h3>
                <div class="keys-config">
                    <div class="key-input">
                        <label>Левая клавиша</label>
                        <div class="key-preview" id="leftKeyPreview">Z</div>
                        <input type="text" id="leftKeyInput" maxlength="1" value="Z" style="display: none;">
                    </div>
                    <div class="key-input">
                        <label>Правая клавиша</label>
                        <div class="key-preview" id="rightKeyPreview">X</div>
                        <input type="text" id="rightKeyInput" maxlength="1" value="X" style="display: none;">
                    </div>
                </div>
                <div class="toggle-switch">
                    <span>Режим редактирования клавиш</span>
                    <label class="switch">
                        <input type="checkbox" id="editKeysToggle">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                
                <h3 class="section-title"><i class="fas fa-volume-up"></i> Звук</h3>
                <div class="toggle-switch">
                    <span>Метроном</span>
                    <label class="switch">
                        <input type="checkbox" id="metronomeToggle">
                        <span class="switch-slider"></span>
                    </label>
                </div>
                
                <div class="action-buttons">
                    <button class="primary-btn" id="startBtn">
                        <i class="fas fa-play"></i> Начать тренировку
                    </button>
                    <button class="secondary-btn" id="resetBtn">
                        <i class="fas fa-redo"></i> Сбросить настройки
                    </button>
                </div>
            </div>
            
            <!-- ПРАВАЯ ПАНЕЛЬ: ТРЕНИРОВКА -->
            <div class="training-area" id="trainingArea">
                <div class="fullscreen-controls" style="display: none;">
                    <button class="fullscreen-btn" id="exitFullscreenBtn" title="Выйти из полноэкранного режима">
                        <i class="fas fa-compress"></i>
                    </button>
                    <button class="fullscreen-btn" id="endSessionBtn" title="Завершить сессию">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                
                <h2 style="color: #66ccff; font-size: 2rem; margin-bottom: 20px;">Тренировка</h2>
                
                <div class="bpm-main-display" id="bpmDisplay">180</div>
                <div class="accuracy-indicator" id="accuracyIndicator"></div>
                
                <div class="training-status">
                    <div class="training-timer" id="timer">00:30</div>
                    <div class="hits-counter" id="hitsCounter">Нажатий: 0</div>
                </div>
                
                <div class="keys-hint">
                    <div class="key-hint-item">
                        <div class="key-hint-box" id="leftKeyHint">Z</div>
                        <div class="key-hint-label">Левый палец</div>
                    </div>
                    <div class="key-hint-item">
                        <div class="key-hint-box" id="rightKeyHint">X</div>
                        <div class="key-hint-label">Правый палец</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- СЧЁТЧИК BPM -->
        <div class="bpm-counter-section">
            <h3 class="section-title"><i class="fas fa-calculator"></i> Измерение текущего BPM</h3>
            <p style="text-align: center; margin-bottom: 20px; color: #aaa;">
                Нажмите "Измерить BPM" и нажимайте выбранные клавиши 10 секунд
            </p>
            
            <div class="counter-display" id="counterDisplay">0</div>
            <div class="counter-timer" id="counterTimer">10.0</div>
            
            <div class="counter-progress">
                <div class="counter-progress-bar" id="counterProgressBar"></div>
            </div>
            
            <div class="counter-buttons">
                <button class="primary-btn" id="startCounterBtn" style="flex: 2;">
                    <i class="fas fa-play"></i> Измерить BPM
                </button>
                <button class="secondary-btn" id="useCounterBtn" style="flex: 1;">
                    Использовать
                </button>
            </div>
            
            <div class="instructions" style="margin-top: 20px;">
                <p><strong>Формула:</strong> BPM = (нажатий за 10 секунд) × 1.5</p>
                <p><strong>Пример:</strong> 180 BPM = 121 нажатие за 10 секунд</p>
            </div>
        </div>
        
        <!-- ПОДВАЛ -->
        <footer>
            <p>Тренажёр для отработки точности нажатий в osu! | Используйте для тренировки стримов</p>
            <p style="margin-top: 10px;">
                <span class="hotkey">Esc</span> - остановить тренировку • 
                <span class="hotkey">F11</span> - полноэкранный режим
            </p>
        </footer>
    </div>
    
    <!-- ОКНО РЕЗУЛЬТАТОВ -->
    <div class="results-overlay" id="resultsOverlay">
        <div class="results-container">
            <div class="results-header">
                <h2><i class="fas fa-chart-bar"></i> Результаты тренировки</h2>
                <p id="sessionSummary">Сессия завершена</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statAccuracy">100%</div>
                    <div class="stat-label">Точность</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTotalHits">0</div>
                    <div class="stat-label">Всего нажатий</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPerfectHits">0</div>
                    <div class="stat-label">Идеально</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgDeviation">0</div>
                    <div class="stat-label">Ср. отклонение (BPM)</div>
                </div>
            </div>
            
            <div class="chart-section">
                <h3>График отклонений от целевого BPM</h3>
                <div class="chart-container">
                    <canvas id="deviationChart"></canvas>
                </div>
            </div>
            
            <div class="results-buttons">
                <button class="primary-btn" id="newSessionBtn">
                    <i class="fas fa-plus"></i> Новая сессия
                </button>
                <button class="secondary-btn" id="closeResultsBtn">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== КОНСТАНТЫ И ПЕРЕМЕННЫЕ ==========
        const targetBPMInput = document.getElementById('targetBPM');
        const toleranceSlider = document.getElementById('toleranceSlider');
        const toleranceValue = document.getElementById('toleranceValue');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const bpmDisplay = document.getElementById('bpmDisplay');
        const timerDisplay = document.getElementById('timer');
        const hitsCounter = document.getElementById('hitsCounter');
        const accuracyIndicator = document.getElementById('accuracyIndicator');
        const trainingArea = document.getElementById('trainingArea');
        const leftKeyPreview = document.getElementById('leftKeyPreview');
        const rightKeyPreview = document.getElementById('rightKeyPreview');
        const leftKeyInput = document.getElementById('leftKeyInput');
        const rightKeyInput = document.getElementById('rightKeyInput');
        const editKeysToggle = document.getElementById('editKeysToggle');
        const metronomeToggle = document.getElementById('metronomeToggle');
        const leftKeyHint = document.getElementById('leftKeyHint');
        const rightKeyHint = document.getElementById('rightKeyHint');
        const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');
        
        // Элементы счётчика BPM
        const counterDisplay = document.getElementById('counterDisplay');
        const counterTimer = document.getElementById('counterTimer');
        const counterProgressBar = document.getElementById('counterProgressBar');
        const startCounterBtn = document.getElementById('startCounterBtn');
        const useCounterBtn = document.getElementById('useCounterBtn');
        
        // Элементы результатов
        const resultsOverlay = document.getElementById('resultsOverlay');
        const sessionSummary = document.getElementById('sessionSummary');
        const statAccuracy = document.getElementById('statAccuracy');
        const statTotalHits = document.getElementById('statTotalHits');
        const statPerfectHits = document.getElementById('statPerfectHits');
        const statAvgDeviation = document.getElementById('statAvgDeviation');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const closeResultsBtn = document.getElementById('closeResultsBtn');
        
        // Переменные состояния
        let isTraining = false;
        let isFullscreen = false;
        let targetBPM = 180;
        let trainingTime = 30;
        let timeLeft = 30;
        let trainerStartTime = 0;
        let trainerHitCount = 0;
        let trainerHits = [];
        let trainerDeviationHistory = [];
        let trainerHitHistory = [];
        let trainerTimerInterval = null;
        let metronomeInterval = null;
        
        // Настройки клавиш
        let leftKey = 'z';
        let rightKey = 'x';
        let isEditingKeys = false;
        
        // Счётчик BPM
        let isCounting = false;
        let counterStartTime = 0;
        let counterHitCount = 0;
        let counterHits = [];
        let counterTimerInterval = null;
        let lastMeasuredBPM = 0;
        
        // Chart.js
        let deviationChart = null;
        const chartColors = {
            perfect: '#4ade80',
            early: '#fbbf24',
            late: '#f87171',
            grid: 'rgba(255, 255, 255, 0.1)',
            text: '#f0f0f0'
        };
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        function init() {
            setupEventListeners();
            updateToleranceDisplay();
            setupPresetButtons();
            setupTimeButtons();
            updateKeyDisplays();
        }
        
        // ========== НАСТРОЙКА СОБЫТИЙ ==========
        function setupEventListeners() {
            // Основные элементы
            targetBPMInput.addEventListener('input', () => {
                targetBPM = parseInt(targetBPMInput.value) || 180;
                bpmDisplay.textContent = targetBPM;
            });
            
            toleranceSlider.addEventListener('input', updateToleranceDisplay);
            startBtn.addEventListener('click', startTrainingSession);
            resetBtn.addEventListener('click', resetSettings);
            
            // Настройка клавиш
            editKeysToggle.addEventListener('change', toggleKeyEditMode);
            leftKeyInput.addEventListener('input', updateLeftKey);
            rightKeyInput.addEventListener('input', updateRightKey);
            
            // Клавиши управления
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Предотвращение стандартного поведения для игровых клавиш
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === leftKey || e.key.toLowerCase() === rightKey) {
                    e.preventDefault();
                }
            });
            
            // Управление полноэкранным режимом
            exitFullscreenBtn.addEventListener('click', exitFullscreen);
            endSessionBtn.addEventListener('click', endTrainingSession);
            
            // Счётчик BPM
            startCounterBtn.addEventListener('click', startBPMCounter);
            useCounterBtn.addEventListener('click', useCounterBPM);
            
            // Результаты
            newSessionBtn.addEventListener('click', startNewSession);
            closeResultsBtn.addEventListener('click', closeResults);
            
            // Глобальные горячие клавиши
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (isTraining) {
                        endTrainingSession();
                    } else if (resultsOverlay.classList.contains('active')) {
                        closeResults();
                    }
                }
                
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });
        }
        
        // ========== ОБНОВЛЕНИЕ ОТОБРАЖЕНИЯ ==========
        function updateToleranceDisplay() {
            const tolerance = parseInt(toleranceSlider.value);
            toleranceValue.textContent = `±${tolerance} BPM`;
        }
        
        function updateKeyDisplays() {
            leftKeyPreview.textContent = leftKey.toUpperCase();
            leftKeyHint.textContent = leftKey.toUpperCase();
            rightKeyPreview.textContent = rightKey.toUpperCase();
            rightKeyHint.textContent = rightKey.toUpperCase();
        }
        
        // ========== НАСТРОЙКА ПРЕСЕТОВ ==========
        function setupPresetButtons() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bpm = parseInt(this.getAttribute('data-bpm'));
                    targetBPMInput.value = bpm;
                    targetBPM = bpm;
                    bpmDisplay.textContent = bpm;
                });
            });
        }
        
        function setupTimeButtons() {
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    trainingTime = parseInt(this.getAttribute('data-time'));
                    timeLeft = trainingTime;
                    updateTimerDisplay();
                });
            });
        }
        
        // ========== НАСТРОЙКА КЛАВИШ ==========
        function toggleKeyEditMode() {
            isEditingKeys = editKeysToggle.checked;
            
            if (isEditingKeys) {
                leftKeyInput.style.display = 'block';
                rightKeyInput.style.display = 'block';
                leftKeyPreview.style.display = 'none';
                rightKeyPreview.style.display = 'none';
                leftKeyInput.value = leftKey.toUpperCase();
                rightKeyInput.value = rightKey.toUpperCase();
                leftKeyInput.focus();
            } else {
                leftKeyInput.style.display = 'none';
                rightKeyInput.style.display = 'none';
                leftKeyPreview.style.display = 'flex';
                rightKeyPreview.style.display = 'flex';
            }
        }
        
        function updateLeftKey() {
            if (leftKeyInput.value.length > 0) {
                leftKey = leftKeyInput.value.toLowerCase();
                updateKeyDisplays();
            }
        }
        
        function updateRightKey() {
            if (rightKeyInput.value.length > 0) {
                rightKey = rightKeyInput.value.toLowerCase();
                updateKeyDisplays();
            }
        }
        
        // ========== ОБРАБОТКА НАЖАТИЙ КЛАВИШ ==========
        function handleKeyDown(e) {
            const key = e.key.toLowerCase();
            
            // Если редактируем клавиши
            if (isEditingKeys) {
                if (document.activeElement === leftKeyInput || document.activeElement === rightKeyInput) {
                    return;
                }
            }
            
            // Обработка для тренировки
            if (isTraining && !isEditingKeys) {
                if (key === leftKey || key === rightKey) {
                    handleTrainingKeyPress(key);
                }
            }
            
            // Обработка для счётчика BPM
            if (isCounting && (key === leftKey || key === rightKey)) {
                handleCounterKeyPress();
            }
        }
        
        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            
            if (key === leftKey) {
                leftKeyHint.classList.remove('active');
            } else if (key === rightKey) {
                rightKeyHint.classList.remove('active');
            }
        }
        
        // ========== ТРЕНИРОВКА ==========
        function startTrainingSession() {
            if (isTraining) return;
            
            isTraining = true;
            startBtn.disabled = true;
            
            // Сброс данных
            timeLeft = trainingTime;
            trainerHitCount = 0;
            trainerHits = [];
            trainerDeviationHistory = [];
            trainerHitHistory = [];
            
            // Обновление отображения
            bpmDisplay.textContent = targetBPM;
            bpmDisplay.className = 'bpm-main-display';
            hitsCounter.textContent = 'Нажатий: 0';
            accuracyIndicator.textContent = '';
            updateTimerDisplay();
            
            // Запуск таймера
            trainerStartTime = Date.now();
            trainerTimerInterval = setInterval(updateTrainingTimer, 1000);
            
            // Запуск метронома
            if (metronomeToggle.checked) {
                startMetronome();
            }
            
            // Переход в полноэкранный режим
            enterFullscreen();
        }
        
        function updateTrainingTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                finishTrainingSession();
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function handleTrainingKeyPress(key) {
            const currentTime = Date.now();
            
            // Подсветка клавиши
            if (key === leftKey) {
                leftKeyHint.classList.add('active');
            } else {
                rightKeyHint.classList.add('active');
            }
            
            // Обновление счётчика
            trainerHitCount++;
            hitsCounter.textContent = `Нажатий: ${trainerHitCount}`;
            
            // Сохранение времени нажатия
            trainerHits.push(currentTime);
            
            // Удаление старых нажатий
            const tenSecondsAgo = currentTime - 10000;
            trainerHits = trainerHits.filter(time => time > tenSecondsAgo);
            
            // Расчёт текущего BPM
            if (trainerHits.length >= 2) {
                const threeSecondsAgo = currentTime - 3000;
                const recentHits = trainerHits.filter(time => time > threeSecondsAgo);
                
                if (recentHits.length >= 2) {
                    const measurementTime = Math.min(3, (currentTime - recentHits[0]) / 1000);
                    const hitsPer10Sec = (recentHits.length / measurementTime) * 10;
                    const userBPM = Math.round(hitsPer10Sec * 1.5);
                    
                    // Сравнение с целевым BPM
                    const bpmDeviation = userBPM - targetBPM;
                    const tolerance = parseInt(toleranceSlider.value);
                    
                    // Определение типа нажатия
                    let hitType = 'perfect';
                    let displayClass = 'perfect';
                    
                    if (bpmDeviation < -tolerance) {
                        hitType = 'late';
                        displayClass = 'late';
                        accuracyIndicator.innerHTML = `<span class="hit-late">Медленно: ${userBPM} BPM (-${Math.abs(bpmDeviation)})</span>`;
                    } else if (bpmDeviation > tolerance) {
                        hitType = 'early';
                        displayClass = 'early';
                        accuracyIndicator.innerHTML = `<span class="hit-early">Быстро: ${userBPM} BPM (+${bpmDeviation})</span>`;
                    } else {
                        hitType = 'perfect';
                        displayClass = 'perfect';
                        accuracyIndicator.innerHTML = `<span class="hit-perfect">Идеально! ${userBPM} BPM</span>`;
                    }
                    
                    // Сохранение данных
                    trainerDeviationHistory.push(bpmDeviation);
                    trainerHitHistory.push({
                        time: (currentTime - trainerStartTime) / 1000,
                        deviation: bpmDeviation,
                        type: hitType,
                        userBPM: userBPM
                    });
                    
                    // Обновление дисплея
                    bpmDisplay.textContent = userBPM;
                    bpmDisplay.className = `bpm-main-display ${displayClass}`;
                    
                    // Сброс цвета через время
                    setTimeout(() => {
                        bpmDisplay.textContent = targetBPM;
                        bpmDisplay.className = 'bpm-main-display';
                    }, 300);
                }
            } else {
                accuracyIndicator.innerHTML = '<span class="hit-perfect">Начали! Держите ритм</span>';
            }
        }
        
        function startMetronome() {
    if (metronomeInterval) clearInterval(metronomeInterval);

    const intervalMs = 60000 / (targetBPM * 4);

    const audioContext = new (window.AudioContext || window.webkitAudioContext());

    metronomeInterval = setInterval(() => {
        if (!isTraining) return;

        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.05);
    }, intervalMs);
}
        
        function finishTrainingSession() {
            endTrainingSession();
            showResults();
        }
        
        function endTrainingSession() {
            if (!isTraining) return;
            
            isTraining = false;
            startBtn.disabled = false;
            
            clearInterval(trainerTimerInterval);
            clearInterval(metronomeInterval);
            
            if (timeLeft > 0) {
                calculateResults();
                showResults();
            }
            
            exitFullscreen();
        }
        
        // ========== ПОЛНОЭКРАННЫЙ РЕЖИМ ==========
        function enterFullscreen() {
            trainingArea.classList.add('fullscreen');
            document.querySelector('.fullscreen-controls').style.display = 'flex';
            isFullscreen = true;
        }
        
        function exitFullscreen() {
            trainingArea.classList.remove('fullscreen');
            document.querySelector('.fullscreen-controls').style.display = 'none';
            isFullscreen = false;
        }
        
        function toggleFullscreen() {
            if (isFullscreen) {
                exitFullscreen();
            } else {
                enterFullscreen();
            }
        }
        
        // ========== РЕЗУЛЬТАТЫ ==========
        function calculateResults() {
            if (trainerHitHistory.length === 0) return;
            
            const perfectHits = trainerHitHistory.filter(h => h.type === 'perfect').length;
            const totalHits = trainerHitHistory.length;
            const accuracy = totalHits > 0 ? Math.round((perfectHits / totalHits) * 100) : 100;
            
            const totalAbsDeviation = trainerDeviationHistory.reduce((sum, dev) => sum + Math.abs(dev), 0);
            const avgDeviation = trainerDeviationHistory.length > 0 ? 
                Math.round(totalAbsDeviation / trainerDeviationHistory.length) : 0;
            
            // Обновление статистики
            statAccuracy.textContent = `${accuracy}%`;
            statTotalHits.textContent = totalHits;
            statPerfectHits.textContent = perfectHits;
            statAvgDeviation.textContent = avgDeviation;
            
            // Обновление заголовка
            const duration = trainingTime - timeLeft;
            sessionSummary.textContent = `Целевой BPM: ${targetBPM} • Длительность: ${duration} сек • Точность: ${accuracy}%`;
        }
        
        function showResults() {
            calculateResults();
            createDeviationChart();
            resultsOverlay.classList.add('active');
        }
        
        function closeResults() {
            resultsOverlay.classList.remove('active');
        }
        
        function startNewSession() {
            closeResults();
            resetSettings();
            startBtn.disabled = false;
        }
        
        function createDeviationChart() {
            const ctx = document.getElementById('deviationChart').getContext('2d');
            
            if (deviationChart) {
                deviationChart.destroy();
            }
            
            const times = trainerHitHistory.map(h => h.time);
            const deviations = trainerHitHistory.map(h => h.deviation);
            const colors = trainerHitHistory.map(h => {
                switch (h.type) {
                    case 'perfect': return chartColors.perfect;
                    case 'early': return chartColors.early;
                    case 'late': return chartColors.late;
                    default: return chartColors.perfect;
                }
            });
            
            deviationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Отклонение от целевого BPM',
                        data: times.map((time, i) => ({x: time, y: deviations[i]})),
                        backgroundColor: colors,
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Время (секунды)',
                                color: chartColors.text,
                                font: { size: 14 }
                            },
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Отклонение (BPM)',
                                color: chartColors.text,
                                font: { size: 14 }
                            },
                            grid: { color: chartColors.grid },
                            ticks: { color: chartColors.text }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: chartColors.text } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    const hit = trainerHitHistory[context.dataIndex];
                                    const type = hit.type === 'perfect' ? 'Идеально' : 
                                                 hit.type === 'early' ? 'Быстро' : 'Медленно';
                                    return `${type}: ${hit.userBPM} BPM (${point.y > 0 ? '+' : ''}${point.y} BPM)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ========== СБРОС НАСТРОЕК ==========
        function resetSettings() {
            endTrainingSession();
            
            targetBPMInput.value = 180;
            targetBPM = 180;
            bpmDisplay.textContent = '180';
            bpmDisplay.className = 'bpm-main-display';
            
            toleranceSlider.value = 5;
            updateToleranceDisplay();
            
            timeLeft = 30;
            updateTimerDisplay();
            
            hitsCounter.textContent = 'Нажатий: 0';
            accuracyIndicator.textContent = '';
            
            leftKeyHint.classList.remove('active');
            rightKeyHint.classList.remove('active');
        }
        
        // ========== СЧЁТЧИК BPM ==========
        function startBPMCounter() {
            if (isCounting) return;
            
            isCounting = true;
            startCounterBtn.disabled = true;
            startCounterBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Измеряю...';
            
            counterStartTime = Date.now();
            counterHitCount = 0;
            counterHits = [];
            
            counterDisplay.textContent = '0';
            counterTimer.textContent = '10.0';
            counterProgressBar.style.width = '0%';
            
            counterTimerInterval = setInterval(updateCounterTimer, 100);
        }
        
        function updateCounterTimer() {
            const elapsed = (Date.now() - counterStartTime) / 1000;
            const timeLeft = 10 - elapsed;
            
            if (timeLeft <= 0) {
                finishBPMCounter();
                return;
            }
            
            counterTimer.textContent = timeLeft.toFixed(1);
            const progress = ((10 - timeLeft) / 10) * 100;
            counterProgressBar.style.width = `${progress}%`;
            
            calculateCounterBPM();
        }
        
        function handleCounterKeyPress() {
            counterHitCount++;
            counterHits.push(Date.now());
            
            const tenSecondsAgo = Date.now() - 10000;
            counterHits = counterHits.filter(time => time > tenSecondsAgo);
        }
        
        function calculateCounterBPM() {
            if (counterHits.length < 2) return;
            
            const now = Date.now();
            const measurementTime = Math.min(10, (now - counterStartTime) / 1000);
            
            if (measurementTime < 0.5) return;
            
            const recentHits = counterHits.filter(time => time > now - measurementTime * 1000);
            const hitsPer10Sec = (recentHits.length / measurementTime) * 10;
            const currentBPM = Math.round(hitsPer10Sec * 1.5);
            
            counterDisplay.textContent = currentBPM;
        }
        
        function finishBPMCounter() {
            clearInterval(counterTimerInterval);
            isCounting = false;
            
            const hitsPer10Sec = counterHitCount;
            const finalBPM = Math.round(hitsPer10Sec * 1.5);
            lastMeasuredBPM = finalBPM;
            
            counterDisplay.textContent = finalBPM;
            counterTimer.textContent = '0.0';
            counterProgressBar.style.width = '100%';
            startCounterBtn.disabled = false;
            startCounterBtn.innerHTML = '<i class="fas fa-play"></i> Измерить BPM';
        }
        
        function useCounterBPM() {
            if (lastMeasuredBPM === 0) {
                alert('Сначала измерьте ваш BPM!');
                return;
            }
            
            targetBPMInput.value = lastMeasuredBPM;
            targetBPM = lastMeasuredBPM;
            bpmDisplay.textContent = lastMeasuredBPM;
            
            useCounterBtn.innerHTML = '<i class="fas fa-check"></i> Использовано';
            setTimeout(() => {
                useCounterBtn.innerHTML = 'Использовать';
            }, 2000);
        }
        
        // ========== ЗАПУСК ==========
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>